    'nci-nutrition-cancer': {
        title: 'Nutrition in Cancer Care (PDQÂ®) - 2024 Update',
        url: 'https://www.cancer.gov/about-cancer/treatment/side-effects/appetite-loss/nutrition-hp-pdq',
        description: 'Comprehensive evidence-based guidelines from NCI on nutrition during cancer treatment.',
        journalInfo: 'Updated quarterly by NCI expert panel. Referenced in over 500 peer-reviewed studies.',
        organization: 'National Cancer Institute (NCI)',
        icon: 'fas fa-hospital'
    },
    'nci-eating-hints': {
        title: 'Eating Hints: Before, During, and After Treatment',
        url: 'https://www.cancer.gov/publications/patient-education/eating-hints',
        description: 'Practical eating tips for cancer patients throughout their treatment journey.',
        journalInfo: 'Patient education resource updated annually by NCI nutrition experts.',
        organization: 'National Cancer Institute (NCI)',
        icon: 'fas fa-utensils'
    },
    'nci-nausea-management': {
        title: 'Managing Nausea and Vomiting - Clinical Guidelines',
        url: 'https://www.cancer.gov/about-cancer/treatment/side-effects/nausea',
        description: 'Evidence-based approaches to managing treatment-related nausea and vomiting.',
        journalInfo: 'Clinical guidelines reviewed by multidisciplinary expert panel.',
        organization: 'National Cancer Institute (NCI)',
        icon: 'fas fa-heartbeat'
    },
    'nci-protein-needs': {
        title: 'Protein Requirements During Cancer Treatment (2024)',
        url: 'https://www.cancer.gov/about-cancer/treatment/side-effects/appetite-loss/nutrition-hp-pdq#section/all',
        description: 'Updated protein intake recommendations for cancer patients.',
        journalInfo: 'Based on latest research in oncology nutrition and metabolism.',
        organization: 'National Cancer Institute (NCI)',
        icon: 'fas fa-dumbbell'
    },

    // American Cancer Society (ACS)
    'acs-nutrition-guidelines': {
        title: 'Cancer Prevention & Early Detection Guidelines 2024',
        url: 'https://www.cancer.org/healthy/eat-healthy-get-active.html',
        description: 'Comprehensive nutrition guidelines for cancer prevention and survivor care.',
        journalInfo: 'Evidence-based recommendations updated every 5 years.',
        organization: 'American Cancer Society (ACS)',
        icon: 'fas fa-shield'
    },
    'acs-food-safety': {
        title: 'Food Safety for People with Cancer (ACS, 2024)',
        url: 'https://www.cancer.org/treatment/survivorship-during-and-after-treatment/staying-active/nutrition/weak-immune-system.html',
        description: 'Food safety guidelines for immunocompromised cancer patients.',
        journalInfo: 'Updated annually based on CDC and FDA food safety recommendations.',
        organization: 'American Cancer Society (ACS)',
        icon: 'fas fa-clipboard-check'
    },
    'acs-weight-management': {
        title: 'Nutrition & Physical Activity Guidelines for Cancer Survivors',
        url: 'https://www.cancer.org/healthy/eat-healthy-get-active/acs-guidelines-nutrition-physical-activity-cancer-prevention.html',
        description: 'Comprehensive guidelines for nutrition and physical activity in cancer survivorship.',
        journalInfo: 'Systematic review of evidence published in CA: A Cancer Journal for Clinicians.',
        organization: 'American Cancer Society (ACS)',
        icon: 'fas fa-running'
    },
    'acs-regional-diets': {
        title: 'Cultural Dietary Considerations in Cancer Care',
        url: 'https://www.cancer.org/treatment/survivorship-during-and-after-treatment/staying-active/nutrition.html',
        description: 'Culturally sensitive nutrition approaches for diverse cancer patient populations.',
        journalInfo: 'Multi-institutional collaborative research on dietary patterns.',
        organization: 'American Cancer Society (ACS)',
        icon: 'fas fa-globe'
    },

    // World Health Organization (WHO)
    'who-global-nutrition': {
        title: 'Global Nutrition Targets 2025 - Cancer Care Focus',
        url: 'https://www.who.int/news-room/fact-sheets/detail/malnutrition',
        description: 'WHO targets for addressing malnutrition in cancer care globally.',
        journalInfo: 'Part of WHO Global Action Plan on NCDs and nutrition.',
        organization: 'World Health Organization (WHO)',
        icon: 'fas fa-globe'
    },
    'who-food-safety-cancer': {
        title: 'WHO Food Safety Guidelines for Immunocompromised Patients',
        url: 'https://www.who.int/news-room/fact-sheets/detail/food-safety',
        description: 'International food safety standards for vulnerable populations including cancer patients.',
        journalInfo: 'WHO technical report series on food safety.',
        organization: 'World Health Organization (WHO)',
        icon: 'fas fa-shield'
    },
    'who-regional-nutrition': {
        title: 'Regional Nutrition Patterns & Cancer Recovery (2024)',
        url: 'https://www.who.int/health-topics/nutrition',
        description: 'Analysis of regional dietary patterns and their impact on cancer recovery.',
        journalInfo: 'WHO regional office collaborative research initiative.',
        organization: 'World Health Organization (WHO)',
        icon: 'fas fa-map-marker'
    },
    'who-micronutrients': {
        title: 'Micronutrient Deficiencies in Cancer Care - WHO Report',
        url: 'https://www.who.int/news-room/fact-sheets/detail/micronutrients',
        description: 'Global assessment of micronutrient deficiencies in cancer care.',
        journalInfo: 'WHO technical consultation report on micronutrient requirements.',
        organization: 'World Health Organization (WHO)',
        icon: 'fas fa-pills'
    },

    // Clinical Research Journals
    'jco-nutrition-2024': {
        title: 'Journal of Clinical Oncology: Nutrition Interventions (2024)',
        url: 'https://ascopubs.org/journal/jco',
        description: 'Latest research on nutrition interventions in oncology practice.',
        journalInfo: 'High-impact peer-reviewed journal, IF: 45.3. Latest systematic reviews.',
        organization: 'Journal of Clinical Oncology',
        icon: 'fas fa-microscope'
    },
    'nutrition-cancer-journal': {
        title: 'Nutrition and Cancer: Geographic Dietary Patterns (2024)',
        url: 'https://www.tandfonline.com/toc/hnuc20/current',
        description: 'Research on geographic variations in dietary patterns and cancer outcomes.',
        journalInfo: 'Specialized nutrition and cancer research journal, peer-reviewed.',
        organization: 'Nutrition and Cancer Journal',
        icon: 'fas fa-chart-line'
    },
    'supportive-care-cancer': {
        title: 'Supportive Care in Cancer: Regional Food Guidelines',
        url: 'https://link.springer.com/journal/520',
        description: 'Evidence-based supportive care approaches including regional nutrition guidelines.',
        journalInfo: 'Official journal of MASCC and ISOO, focus on supportive care research.',
        organization: 'Supportive Care in Cancer',
        icon: 'fas fa-hands-helping'
    },
    'oncology-nutrition': {
        title: 'Clinical Journal of Oncology Nutrition (Latest Issue)',
        url: 'https://www.oncologynutrition.org',
        description: 'Specialized clinical nutrition research for oncology practice.',
        journalInfo: 'Peer-reviewed journal focusing on clinical applications.',
        organization: 'Clinical Journal of Oncology Nutrition',
        icon: 'fas fa-stethoscope'
    },

    // Geographic Nutrition Guidelines
    'mediterranean-diet-cancer': {
        title: 'Mediterranean Diet in Cancer Prevention (Europe)',
        url: 'https://www.mdpi.com/journal/nutrients',
        description: 'Research on Mediterranean dietary patterns and cancer prevention in European populations.',
        journalInfo: 'Multi-center European research collaboration, published in Nutrients.',
        organization: 'European Research Consortium',
        icon: 'fas fa-leaf'
    },
    'asian-diet-patterns': {
        title: 'Traditional Asian Diets & Cancer Recovery',
        url: 'https://academic.oup.com/ajcn',
        description: 'Analysis of traditional Asian dietary patterns and their role in cancer recovery.',
        journalInfo: 'Published in American Journal of Clinical Nutrition, Asian cohort studies.',
        organization: 'Asian Nutrition Research Network',
        icon: 'fas fa-circle'
    },
    'plant-based-americas': {
        title: 'Plant-Based Nutrition in the Americas',
        url: 'https://www.nutrition.org/our-journals/advances-in-nutrition/',
        description: 'Research on plant-based dietary approaches in cancer care across the Americas.',
        journalInfo: 'Multi-country collaborative study, published in Advances in Nutrition.',
        organization: 'Pan-American Nutrition Society',
        icon: 'fas fa-seedling'
    },
    'regional-food-access': {
        title: 'Food Security & Cancer Care by Region',
        url: 'https://www.cambridge.org/core/journals/public-health-nutrition',
        description: 'Analysis of food security challenges in cancer care across different regions.',
        journalInfo: 'Global health research published in Public Health Nutrition journal.',
        organization: 'Global Health Nutrition Network',
        icon: 'fas fa-balance-scale'
    }
};

// Navigation and UI functions
let currentSection = 'welcomeSection';

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section, .welcome-section').forEach(section => {
        section.classList.add('hidden');
    });
    
    // Show target section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.remove('hidden');
        currentSection = sectionId;
        
        // Scroll to top of the page smoothly
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        
        // Update active navigation item
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        
        // Find and activate the corresponding nav item
        const navMapping = {
            'welcomeSection': 'welcome',
            'profileSection': 'profile', 
            'recommendationsSection': 'recommendations',
            'guidanceSection': 'guidance',
            'learnSection': 'learn',
            'recipesSection': 'recipes',
            'trackingSection': 'tracking',
            'resourcesSection': 'resources'
        };
        
        const navKey = navMapping[sectionId];
        if (navKey) {
            const activeNavItem = document.querySelector(`[data-section="${navKey}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
        }
        
        // Load section-specific content
        if (sectionId === 'recipesSection') {
            loadRecipes();
        } else if (sectionId === 'recommendationsSection') {
            loadRecommendations();
        } else if (sectionId === 'learnSection') {
            initializeLearnSection();
        } else if (sectionId === 'trackingSection') {
            initializeTracking();
        } else if (sectionId === 'resourcesSection') {
            loadResources();
        }
    }
}

// Recipe functions
function loadRecipes() {
    filterRecipes('all');
}

function filterRecipes(category) {
    let recipesToShow = [];
    
    if (category === 'all') {
        // Show all recipes from all categories
        for (const cat in camRecipeData) {
            recipesToShow = recipesToShow.concat(camRecipeData[cat]);
        }
    } else if (camRecipeData[category]) {
        recipesToShow = camRecipeData[category];
    }
    
    renderRecipes(recipesToShow);
}

function showRecommendedRecipes() {
    // Filter recipes to show only those from recommended categories
    let recommendedRecipes = [];
    
    if (currentUserRecommendedFilters.length === 0) {
        // Fallback to all recipes if no recommendations available
        for (const cat in camRecipeData) {
            recommendedRecipes = recommendedRecipes.concat(camRecipeData[cat]);
        }
    } else {
        // Show recipes from recommended categories only
        currentUserRecommendedFilters.forEach(filter => {
            if (camRecipeData[filter]) {
                recommendedRecipes = recommendedRecipes.concat(camRecipeData[filter]);
            }
        });
    }
    
    // Update filter buttons to show "recommended" state
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Activate the "All Recipes" button and update its text temporarily
    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
    if (allButton) {
        allButton.classList.add('active');
        const originalText = allButton.textContent;
        allButton.textContent = 'Your Recommended Recipes';
        
        // Restore original text after 3 seconds
        setTimeout(() => {
            if (allButton.classList.contains('active')) {
                allButton.textContent = originalText;
            }
        }, 3000);
    }
    
    renderRecipes(recommendedRecipes);
    
    // Show a message about the filtered results
    const recipesGrid = document.getElementById('recipesGrid');
    if (recipesGrid && recommendedRecipes.length > 0) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'recommendation-notice';
        messageDiv.innerHTML = `
            <i class="fas fa-star"></i>
            <span>Showing ${recommendedRecipes.length} recipes personalized for your profile</span>
            <button onclick="restoreAllRecipes()" class="btn-link">View all recipes</button>
        `;
        recipesGrid.parentNode.insertBefore(messageDiv, recipesGrid);
        
        // Remove message after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 5000);
    }
}

function restoreAllRecipes() {
    // Restore the "All Recipes" button text
    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
    if (allButton) {
        allButton.textContent = 'All Recipes';
    }
    
    // Remove any existing recommendation notice
    const existingNotice = document.querySelector('.recommendation-notice');
    if (existingNotice && existingNotice.parentNode) {
        existingNotice.parentNode.removeChild(existingNotice);
    }
    
    // Show all recipes
    filterRecipes('all');
}

function renderRecipes(recipes) {
    const container = document.getElementById('recipesGrid');
    if (!container) return;
    
    if (recipes.length === 0) {
        container.innerHTML = '<p class="no-recipes">No recipes found for this filter.</p>';
        return;
    }
    
    const html = recipes.map(recipe => `
        <div class="recipe-card" onclick="openRecipeModal('${recipe.id}')" data-recipe-id="${recipe.id}">
            <div class="recipe-image" style="background-image: url('${recipe.image || ''}')">
                <i class="fas fa-utensils"></i>
                ${recipe.origin ? `<span class="recipe-region">${recipe.tradition}</span>` : ''}
            </div>
            <div class="recipe-content">
                <div class="recipe-meta">
                    <span class="recipe-tradition">${recipe.tradition}</span>
                    <span class="recipe-origin">${recipe.origin}</span>
                </div>
                <h3>${recipe.name}</h3>
                <p class="recipe-description">${recipe.description}</p>
                <div class="recipe-purpose">
                    <strong>Purpose:</strong> ${recipe.purpose}
                </div>
                <div class="recipe-stats">
                    <span><i class="fas fa-clock"></i> ${recipe.prepTime}</span>
                    <span><i class="fas fa-users"></i> ${recipe.servings} servings</span>
                    <span><i class="fas fa-fire"></i> ${recipe.nutritionFacts.calories} cal</span>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Recipe Modal Functions
function openRecipeModal(recipeId) {
    // Find the recipe across all categories
    let recipe = null;
    for (const category in camRecipeData) {
        recipe = camRecipeData[category].find(r => r.id === recipeId);
        if (recipe) break;
    }
    
    if (!recipe) return;
    
    // Populate modal content
    const modal = document.getElementById('recipeModal');
    const modalImage = document.getElementById('recipeModalImage');
    const modalTitle = document.getElementById('recipeModalTitle');
    const modalRegion = document.getElementById('recipeModalRegion');
    const modalPrepTime = document.getElementById('modalPrepTime');
    const modalProtein = document.getElementById('modalProtein');
    const modalCalories = document.getElementById('modalCalories');
    const modalIngredients = document.getElementById('modalIngredients');
    const modalInstructions = document.getElementById('modalInstructions');
    const modalNutritionTips = document.getElementById('modalNutritionTips');
    const modalCancerBenefits = document.getElementById('modalCancerBenefits');
    
    // Set background image
    if (recipe.image) {
        modalImage.style.backgroundImage = `url('${recipe.image}')`;
    }
    
    // Populate content with new CAM structure
    modalTitle.textContent = recipe.name;
    modalRegion.textContent = recipe.origin || 'International';
    modalPrepTime.textContent = recipe.prepTime;
    modalProtein.textContent = recipe.nutritionFacts?.protein || 'N/A';
    modalCalories.textContent = recipe.nutritionFacts?.calories || 'N/A';
    
    // Populate ingredients
    modalIngredients.innerHTML = recipe.ingredients 
        ? recipe.ingredients.map(ingredient => `<li>${ingredient}</li>`).join('')
        : '<li>Ingredients not available</li>';
    
    // Populate instructions
    modalInstructions.innerHTML = recipe.instructions 
        ? recipe.instructions.map(instruction => `<li>${instruction}</li>`).join('')
        : '<li>Instructions not available</li>';
    
    // Populate benefits - combine purpose and benefits
    const nutritionText = `${recipe.purpose || ''}\n\nBenefits:\n${recipe.benefits ? recipe.benefits.join('\nâ€¢ ') : 'Benefits not available.'}`;
    modalNutritionTips.textContent = nutritionText;
    
    // Show research links if available
    const researchInfo = recipe.researchLinks && recipe.researchLinks.length > 0 
        ? `Research Support:\n${recipe.researchLinks.map(link => `â€¢ ${link.title}: ${link.summary} (${link.source})`).join('\n')}`
        : 'Research information not available.';
    modalCancerBenefits.textContent = researchInfo;
    
    // Show modal
    modal.classList.remove('hidden');
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeRecipeModal() {
    const modal = document.getElementById('recipeModal');
    modal.classList.add('hidden');
    
    // Restore body scroll
    document.body.style.overflow = '';
}

// Other placeholder functions
function loadRecommendations() {
    const userData = getUserProfile();
    if (!userData) {
        document.getElementById('personalizedContent').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Please complete your personal assessment first to get customized recommendations.</p>
                <button class="btn btn-primary" onclick="showSection('profileSection')">
                    <i class="fas fa-user-circle"></i> Complete Assessment
                </button>
            </div>
        `;
        return;
    }

    generatePersonalizedRecommendations(userData);
}

function generatePersonalizedRecommendations(userData) {
    const container = document.getElementById('personalizedContent');
    
    // Generate location-based recommendations
    const locationRecommendations = getLocationBasedRecommendations(userData.location);
    
    // Generate symptom-based recommendations
    const symptomRecommendations = getSymptomBasedRecommendations(userData.symptoms);
    
    // Generate treatment stage recommendations
    const treatmentRecommendations = getTreatmentStageRecommendations(userData.treatmentStage);
    
    // Generate cancer type specific recommendations
    const cancerTypeRecommendations = getCancerTypeRecommendations(userData.cancerType);
    
    // Generate holistic recommendations
    const holisticRecommendations = getHolisticRecommendations(userData);

    // Helper function to format text
    const formatText = (text) => {
        return text.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    };

    container.innerHTML = `
        <div class="recommendations-container">
            <div class="user-summary">
                <h3><i class="fas fa-user"></i> Your Profile Summary</h3>
                <div class="profile-tags">
                    <span class="profile-tag">${formatText(userData.cancerType)} Cancer</span>
                    <span class="profile-tag">${formatText(userData.treatmentStage)}</span>
                    <span class="profile-tag">${formatText(userData.location)}</span>
                    ${userData.symptoms.length > 0 ? userData.symptoms.map(s => `<span class="profile-tag symptom">${formatText(s)}</span>`).join('') : ''}
                </div>
            </div>

            ${cancerTypeRecommendations}
            ${holisticRecommendations}
            ${treatmentRecommendations}
            ${symptomRecommendations}
            ${locationRecommendations}

            <div class="recommendation-card">
                <h3><i class="fas fa-utensils"></i> Recommended Recipe Categories</h3>
                <div class="recipe-category-recommendations">
                    ${getRecommendedRecipeCategories(userData)}
                </div>
            </div>

            <div class="recommendation-card">
                <h3><i class="fas fa-chart-line"></i> Next Steps</h3>
                <div class="next-steps">
                    <button class="btn btn-primary" onclick="showSection('recipesSection'); setTimeout(() => showRecommendedRecipes(), 100);">
                        <i class="fas fa-utensils"></i> Explore Recommended Recipes
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('trackingSection')">
                        <i class="fas fa-chart-pie"></i> Start Tracking Nutrition
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('guidanceSection')">
                        <i class="fas fa-book-medical"></i> View General Guidelines
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getUserProfile() {
    return safeLocalStorageGet('userProfile');
}

function saveUserProfile(profileData) {
    if (!safeLocalStorageSet('userProfile', profileData)) {
        console.error('Failed to save user profile');
        // Could show user notification here
    }
}

function getLocationBasedRecommendations(location) {
    const locationGuides = {
        'north-america': {
            title: 'North American Nutrition Guidelines',
            content: 'Following NCI (National Cancer Institute) and ACS (American Cancer Society) guidelines for optimal nutrition during cancer treatment.',
            resources: ['Focus on anti-inflammatory foods', 'Ensure food safety with proper cooking temperatures', 'Consider Mediterranean diet patterns']
        },
        'europe': {
            title: 'European Nutrition Standards',
            content: 'Based on ESMO (European Society for Medical Oncology) nutritional guidelines and local dietary patterns.',
            resources: ['Emphasize whole grains and lean proteins', 'Include traditional fermented foods', 'Follow DASH diet principles']
        },
        'asia-pacific': {
            title: 'Asia-Pacific Dietary Approaches',
            content: 'Incorporating traditional Asian dietary wisdom with modern oncology nutrition science.',
            resources: ['Include miso and fermented foods for gut health', 'Emphasize rice-based carbohydrates', 'Use ginger and turmeric for anti-inflammatory effects']
        },
        'middle-east': {
            title: 'Middle Eastern Nutrition Guidance',
            content: 'Incorporating traditional Mediterranean and Middle Eastern foods with evidence-based cancer nutrition.',
            resources: ['Use olive oil and nuts for healthy fats', 'Include legumes and whole grains', 'Emphasize fresh herbs and spices']
        },
        'africa': {
            title: 'African Dietary Approaches',
            content: 'Combining traditional African foods with modern nutritional science for cancer care.',
            resources: ['Include traditional grains like millet and sorghum', 'Use indigenous vegetables and fruits', 'Focus on plant-based proteins']
        },
        'south-america': {
            title: 'South American Nutrition Guidelines',
            content: 'Incorporating traditional South American foods with evidence-based cancer nutrition principles.',
            resources: ['Include quinoa and other ancient grains', 'Use tropical fruits for antioxidants', 'Emphasize beans and legumes']
        },
        'australia': {
            title: 'Australian/Oceanian Guidelines',
            content: 'Following Australian cancer nutrition guidelines with focus on fresh, local produce.',
            resources: ['Emphasize fresh seafood for omega-3s', 'Include native fruits and vegetables', 'Focus on outdoor-fresh produce']
        }
    };

    const guide = locationGuides[location] || locationGuides['north-america'];
    
    return `
        <div class="recommendation-card">
            <h3><i class="fas fa-globe"></i> ${guide.title}</h3>
            <p>${guide.content}</p>
            <ul>
                ${guide.resources.map(resource => `<li>${resource}</li>`).join('')}
            </ul>
        </div>
    `;
}

function getSymptomBasedRecommendations(symptoms) {
    if (!symptoms || symptoms.length === 0) return '';
    
    const symptomGuides = {
        'nausea': 'Try ginger tea, bland foods, and small frequent meals',
        'appetite-loss': 'Focus on nutrient-dense, high-calorie foods and protein smoothies',
        'mouth-sores': 'Choose soft, smooth foods and avoid acidic or spicy items',
        'fatigue': 'Prioritize easy-to-prepare, energy-dense meals',
        'taste-changes': 'Experiment with herbs, spices, and temperature variations',
        'digestive': 'Consider low-fiber options and probiotic foods'
    };

    return `
        <div class="recommendation-card">
            <h3><i class="fas fa-stethoscope"></i> Symptom Management</h3>
            <p>Targeted nutrition strategies for your current symptoms:</p>
            <ul>
                ${symptoms.map(symptom => `<li><strong>${symptom}:</strong> ${symptomGuides[symptom] || 'Consult with your healthcare team for specific guidance'}</li>`).join('')}
            </ul>
        </div>
    `;
}

function getTreatmentStageRecommendations(stage) {
    const stageGuides = {
        'pre-treatment': {
            title: 'Pre-Treatment Preparation',
            recommendations: ['Build nutrient stores', 'Focus on immune-supporting foods', 'Maintain healthy weight']
        },
        'active-treatment': {
            title: 'During Active Treatment',
            recommendations: ['Prioritize protein intake', 'Stay hydrated', 'Manage side effects through nutrition']
        },
        'post-treatment': {
            title: 'Recovery Phase',
            recommendations: ['Rebuild strength with balanced nutrition', 'Support healing with anti-inflammatory foods', 'Gradually increase activity']
        },
        'survivorship': {
            title: 'Long-term Survivorship',
            recommendations: ['Focus on cancer prevention foods', 'Maintain healthy weight', 'Follow general healthy eating patterns']
        }
    };

    const guide = stageGuides[stage] || stageGuides['active-treatment'];
    
    return `
        <div class="recommendation-card">
            <h3><i class="fas fa-heartbeat"></i> ${guide.title}</h3>
            <ul>
                ${guide.recommendations.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
        </div>
    `;
}

function getCancerTypeRecommendations(cancerType) {
    const cancerGuides = {
        // Most Common Cancers
        'breast': {
            title: 'Breast Cancer',
            guidance: 'Focus on soy foods (tofu, tempeh), cruciferous vegetables (broccoli, cauliflower), omega-3 fatty acids, and maintain healthy weight. Limit alcohol and processed foods.',
            keyNutrients: ['Fiber', 'Antioxidants', 'Omega-3s', 'Isoflavones'],
            foods: ['Soy products', 'Leafy greens', 'Berries', 'Fatty fish', 'Whole grains']
        },
        'lung': {
            title: 'Lung Cancer',
            guidance: 'Emphasize antioxidant-rich foods, maintain protein intake, and include anti-inflammatory foods. Beta-carotene from food sources, not supplements.',
            keyNutrients: ['Antioxidants', 'Protein', 'Vitamin C', 'Beta-carotene'],
            foods: ['Citrus fruits', 'Sweet potatoes', 'Spinach', 'Lean proteins', 'Green tea']
        },
        'colorectal': {
            title: 'Colorectal Cancer',
            guidance: 'Include high-fiber foods post-treatment, limit processed and red meats, focus on plant-based proteins and prebiotics for gut health.',
            keyNutrients: ['Fiber', 'Folate', 'Calcium', 'Prebiotics'],
            foods: ['Whole grains', 'Legumes', 'Vegetables', 'Yogurt', 'Fish']
        },
        'prostate': {
            title: 'Prostate Cancer',
            guidance: 'Consider lycopene-rich foods, limit high-fat dairy, include cruciferous vegetables and green tea. Focus on plant-based diet.',
            keyNutrients: ['Lycopene', 'Selenium', 'Vitamin E', 'Omega-3s'],
            foods: ['Tomatoes', 'Watermelon', 'Cruciferous vegetables', 'Nuts', 'Green tea']
        },
        'skin': {
            title: 'Skin Cancer (Melanoma)',
            guidance: 'Focus on antioxidants, vitamin D optimization, and anti-inflammatory foods. Include foods rich in vitamins C and E.',
            keyNutrients: ['Antioxidants', 'Vitamin D', 'Vitamin C', 'Vitamin E'],
            foods: ['Colorful fruits', 'Nuts', 'Seeds', 'Leafy greens', 'Fatty fish']
        },
        'bladder': {
            title: 'Bladder Cancer',
            guidance: 'Stay well-hydrated, include cruciferous vegetables, limit processed meats, and focus on antioxidant-rich foods.',
            keyNutrients: ['Antioxidants', 'Folate', 'Vitamin C', 'Fluids'],
            foods: ['Broccoli', 'Berries', 'Green tea', 'Water-rich fruits', 'Whole grains']
        },
        'kidney': {
            title: 'Kidney Cancer',
            guidance: 'Monitor protein and phosphorus intake, stay hydrated, include antioxidants, and work with dietitian for kidney function.',
            keyNutrients: ['Controlled protein', 'Antioxidants', 'Potassium balance'],
            foods: ['Lean proteins', 'Berries', 'Apples', 'Cabbage', 'Cauliflower']
        },
        'thyroid': {
            title: 'Thyroid Cancer',
            guidance: 'Focus on iodine balance, selenium-rich foods, and anti-inflammatory diet. Monitor cruciferous vegetables if on thyroid medication.',
            keyNutrients: ['Selenium', 'Iodine balance', 'Antioxidants'],
            foods: ['Brazil nuts', 'Seafood', 'Berries', 'Lean proteins', 'Whole grains']
        },
        'pancreatic': {
            title: 'Pancreatic Cancer',
            guidance: 'Focus on digestive enzymes, small frequent meals, healthy fats, and blood sugar management. Work closely with dietitian.',
            keyNutrients: ['Healthy fats', 'Digestive enzymes', 'B vitamins'],
            foods: ['Avocado', 'Olive oil', 'Small meals', 'Cooked vegetables', 'Lean proteins']
        },
        'liver': {
            title: 'Liver Cancer',
            guidance: 'Limit protein if liver function compromised, avoid alcohol completely, include antioxidants, and monitor sodium intake.',
            keyNutrients: ['Controlled protein', 'Antioxidants', 'Low sodium'],
            foods: ['Leafy greens', 'Berries', 'Low-sodium foods', 'Whole grains', 'Lean proteins']
        },
        
        // Blood Cancers
        'leukemia': {
            title: 'Leukemia',
            guidance: 'Prioritize food safety and infection prevention, maintain energy intake, include immune-supporting nutrients.',
            keyNutrients: ['Protein', 'Iron', 'B vitamins', 'Immune support'],
            foods: ['Well-cooked foods', 'Lean proteins', 'Fortified foods', 'Pasteurized dairy']
        },
        'lymphoma': {
            title: 'Lymphoma',
            guidance: 'Focus on immune-supporting nutrients, maintain energy intake, and follow food safety guidelines during treatment.',
            keyNutrients: ['Antioxidants', 'Protein', 'Immune support'],
            foods: ['Colorful fruits', 'Vegetables', 'Lean proteins', 'Well-cooked foods']
        },
        'myeloma': {
            title: 'Multiple Myeloma',
            guidance: 'Focus on bone health with calcium and vitamin D, maintain protein for muscle mass, and support kidney function.',
            keyNutrients: ['Calcium', 'Vitamin D', 'Protein', 'Kidney support'],
            foods: ['Dairy products', 'Leafy greens', 'Lean proteins', 'Fortified foods']
        },
        
        // Head & Neck Cancers
        'head-neck': {
            title: 'Head & Neck Cancer',
            guidance: 'Focus on soft, moist textures, nutrient-dense foods, and maintain hydration. May need texture modifications.',
            keyNutrients: ['High calories', 'Protein', 'Vitamins', 'Hydration'],
            foods: ['Smoothies', 'Soft proteins', 'Cooked vegetables', 'Nutritional supplements']
        },
        'brain': {
            title: 'Brain Cancer',
            guidance: 'Focus on anti-inflammatory foods, omega-3s, and maintaining energy for cognitive function. Include antioxidants.',
            keyNutrients: ['Omega-3s', 'Antioxidants', 'B vitamins'],
            foods: ['Fatty fish', 'Walnuts', 'Berries', 'Leafy greens', 'Whole grains']
        },
        'oral': {
            title: 'Oral Cancer',
            guidance: 'Soft, moist foods, avoid spicy/acidic foods, maintain nutrition with liquid supplements if needed.',
            keyNutrients: ['High calories', 'Protein', 'Vitamins'],
            foods: ['Smoothies', 'Soft fruits', 'Cooked grains', 'Protein shakes']
        },
        'throat': {
            title: 'Throat Cancer',
            guidance: 'Soft, easy-to-swallow foods, avoid irritating textures, focus on liquid nutrition if swallowing difficult.',
            keyNutrients: ['High calories', 'Protein', 'Hydration'],
            foods: ['Purees', 'Smoothies', 'Soft proteins', 'Nutritional drinks']
        },
        
        // Digestive System Cancers
        'stomach': {
            title: 'Stomach Cancer',
            guidance: 'Small, frequent meals, limit spicy foods, focus on easily digestible proteins and carbohydrates.',
            keyNutrients: ['B12', 'Iron', 'Protein', 'Easy digestion'],
            foods: ['Small meals', 'Lean proteins', 'Rice', 'Bananas', 'Cooked vegetables']
        },
        'esophageal': {
            title: 'Esophageal Cancer',
            guidance: 'Soft, moist foods, avoid hot/spicy foods, may need liquid nutrition, focus on swallowing-friendly textures.',
            keyNutrients: ['High calories', 'Protein', 'Soft textures'],
            foods: ['Smoothies', 'Purees', 'Soft proteins', 'Moist grains']
        },
        'gallbladder': {
            title: 'Gallbladder Cancer',
            guidance: 'Low-fat diet, avoid fried foods, focus on lean proteins and complex carbohydrates.',
            keyNutrients: ['Low fat', 'Fiber', 'Lean protein'],
            foods: ['Lean meats', 'Vegetables', 'Whole grains', 'Low-fat dairy']
        },
        'bile-duct': {
            title: 'Bile Duct Cancer',
            guidance: 'Low-fat diet, support liver function, include antioxidants, work with dietitian for fat absorption.',
            keyNutrients: ['Low fat', 'Antioxidants', 'Liver support'],
            foods: ['Lean proteins', 'Vegetables', 'Whole grains', 'Berries']
        },
        'small-intestine': {
            title: 'Small Intestine Cancer',
            guidance: 'Focus on easy digestion, may need low-fiber during treatment, maintain hydration and electrolytes.',
            keyNutrients: ['Easy digestion', 'Electrolytes', 'Hydration'],
            foods: ['White rice', 'Bananas', 'Cooked vegetables', 'Lean proteins']
        },
        
        // Gynecologic Cancers
        'ovarian': {
            title: 'Ovarian Cancer',
            guidance: 'Anti-inflammatory foods, maintain healthy weight, include folate-rich foods and antioxidants.',
            keyNutrients: ['Folate', 'Antioxidants', 'Anti-inflammatory'],
            foods: ['Leafy greens', 'Berries', 'Whole grains', 'Fatty fish']
        },
        'cervical': {
            title: 'Cervical Cancer',
            guidance: 'Focus on folate, antioxidants, and immune-supporting nutrients. Include colorful fruits and vegetables.',
            keyNutrients: ['Folate', 'Antioxidants', 'Vitamin C'],
            foods: ['Citrus fruits', 'Leafy greens', 'Whole grains', 'Colorful vegetables']
        },
        'uterine': {
            title: 'Uterine Cancer',
            guidance: 'Maintain healthy weight, include fiber and antioxidants, focus on plant-based foods.',
            keyNutrients: ['Fiber', 'Antioxidants', 'Phytonutrients'],
            foods: ['Whole grains', 'Vegetables', 'Fruits', 'Legumes']
        },
        'vulvar': {
            title: 'Vulvar Cancer',
            guidance: 'Focus on immune-supporting nutrients, antioxidants, and maintaining overall nutrition status.',
            keyNutrients: ['Antioxidants', 'Immune support', 'Protein'],
            foods: ['Colorful fruits', 'Vegetables', 'Lean proteins', 'Whole grains']
        },
        'vaginal': {
            title: 'Vaginal Cancer',
            guidance: 'Include antioxidants, immune-supporting foods, and maintain healthy weight with balanced nutrition.',
            keyNutrients: ['Antioxidants', 'Immune support', 'Balance'],
            foods: ['Berries', 'Leafy greens', 'Lean proteins', 'Whole grains']
        },
        
        // Urologic Cancers
        'testicular': {
            title: 'Testicular Cancer',
            guidance: 'Focus on antioxidants, maintain energy for treatment, include zinc and selenium-rich foods.',
            keyNutrients: ['Antioxidants', 'Zinc', 'Selenium'],
            foods: ['Nuts', 'Seeds', 'Lean meats', 'Whole grains', 'Fruits']
        },
        'penile': {
            title: 'Penile Cancer',
            guidance: 'Focus on immune-supporting nutrients, antioxidants, and maintaining overall nutritional status.',
            keyNutrients: ['Immune support', 'Antioxidants', 'Protein'],
            foods: ['Colorful fruits', 'Vegetables', 'Lean proteins', 'Whole grains']
        },
        
        // Bone & Soft Tissue
        'bone': {
            title: 'Bone Cancer',
            guidance: 'Focus on bone health with calcium and vitamin D, maintain protein for healing, include anti-inflammatory foods.',
            keyNutrients: ['Calcium', 'Vitamin D', 'Protein', 'Anti-inflammatory'],
            foods: ['Dairy products', 'Leafy greens', 'Fatty fish', 'Lean proteins']
        },
        'soft-tissue': {
            title: 'Soft Tissue Sarcoma',
            guidance: 'Focus on protein for tissue repair, include antioxidants and anti-inflammatory foods.',
            keyNutrients: ['Protein', 'Antioxidants', 'Anti-inflammatory'],
            foods: ['Lean proteins', 'Berries', 'Leafy greens', 'Fatty fish']
        },
        
        // Endocrine Cancers
        'adrenal': {
            title: 'Adrenal Cancer',
            guidance: 'Focus on blood sugar balance, stress-supporting nutrients, and anti-inflammatory foods.',
            keyNutrients: ['Blood sugar balance', 'B vitamins', 'Magnesium'],
            foods: ['Whole grains', 'Lean proteins', 'Vegetables', 'Nuts']
        },
        'parathyroid': {
            title: 'Parathyroid Cancer',
            guidance: 'Monitor calcium levels, focus on bone health, and work closely with healthcare team on mineral balance.',
            keyNutrients: ['Calcium balance', 'Vitamin D', 'Phosphorus'],
            foods: ['Balanced calcium', 'Leafy greens', 'Lean proteins']
        },
        
        // Rare Cancers
        'mesothelioma': {
            title: 'Mesothelioma',
            guidance: 'Focus on anti-inflammatory foods, maintain energy, and support respiratory health with antioxidants.',
            keyNutrients: ['Anti-inflammatory', 'Antioxidants', 'Energy'],
            foods: ['Fatty fish', 'Berries', 'Leafy greens', 'Whole grains']
        },
        'neuroendocrine': {
            title: 'Neuroendocrine Tumors',
            guidance: 'May need to limit certain foods that trigger symptoms, focus on balanced nutrition and work with specialist.',
            keyNutrients: ['Balanced nutrition', 'Symptom management'],
            foods: ['Whole foods', 'Lean proteins', 'Complex carbs', 'Vegetables']
        },
        'carcinoid': {
            title: 'Carcinoid Tumor',
            guidance: 'May need to avoid tyramine-rich foods, focus on niacin, and work with dietitian for trigger foods.',
            keyNutrients: ['Niacin', 'Trigger avoidance', 'Balance'],
            foods: ['Fresh foods', 'Lean proteins', 'Whole grains', 'Vegetables']
        },
        'gastrointestinal-stromal': {
            title: 'GIST',
            guidance: 'Focus on easy digestion, may need texture modifications, maintain nutrition during targeted therapy.',
            keyNutrients: ['Easy digestion', 'Protein', 'Energy'],
            foods: ['Soft foods', 'Lean proteins', 'Cooked vegetables', 'Whole grains']
        },
        'other': {
            title: 'Other Cancer Types',
            guidance: 'Follow general cancer nutrition guidelines with focus on your specific needs and treatment requirements.',
            keyNutrients: ['Balanced nutrition', 'Individualized care'],
            foods: ['Variety of whole foods', 'Lean proteins', 'Fruits', 'Vegetables']
        }
    };

    const guide = cancerGuides[cancerType] || cancerGuides['other'];
    
    return `
        <div class="recommendation-card">
            <h3><i class="fas fa-dna"></i> ${guide.title} Specific Guidance</h3>
            <p><strong>Key Recommendations:</strong> ${guide.guidance}</p>
            <div class="nutrition-details">
                <div class="key-nutrients">
                    <h4><i class="fas fa-star"></i> Key Nutrients:</h4>
                    <ul>
                        ${guide.keyNutrients.map(nutrient => `<li>${nutrient}</li>`).join('')}
                    </ul>
                </div>
                <div class="recommended-foods">
                    <h4><i class="fas fa-apple-alt"></i> Recommended Foods:</h4>
                    <ul>
                        ${guide.foods.map(food => `<li>${food}</li>`).join('')}
                    </ul>
                </div>
            </div>
            <div class="disclaimer">
                <p><small><i class="fas fa-info-circle"></i> These are general guidelines. Always consult with your healthcare team and registered dietitian for personalized recommendations based on your specific treatment plan and individual needs.</small></p>
            </div>
        </div>
    `;
}

function getHolisticRecommendations(userData) {
    // Return early if user prefers conventional approach only
    if (userData.nutritionApproach === 'conventional') {
        return '';
    }
    
    const traditions = userData.traditionalMedicine || [];
    const mindBodyPractices = userData.mindBodyPractices || [];
    const constitution = userData.constitutionalType;
    
    let holisticContent = '';
    
    // Build holistic recommendations based on selected traditions
    if (traditions.length > 0 || mindBodyPractices.length > 0 || constitution) {
        holisticContent += `
            <div class="recommendation-card holistic-recommendations">
                <h3><i class="fas fa-yin-yang"></i> Holistic & Integrative Approaches</h3>
                <div class="holistic-content">
        `;
        
        // Traditional Medicine Recommendations
        if (traditions.includes('ayurveda')) {
            holisticContent += `
                <div class="tradition-section">
                    <h4><i class="fas fa-leaf"></i> Ayurvedic Approach</h4>
                    <p>Focus on balancing your doshas through warming spices, proper food combining, and mindful eating practices.</p>
                    <div class="tradition-foods">
                        <strong>Recommended:</strong> Turmeric, ginger, cumin, cooked vegetables, warm foods
                    </div>
                </div>
            `;
        }
        
        if (traditions.includes('tcm')) {
            holisticContent += `
                <div class="tradition-section">
                    <h4><i class="fas fa-mountain"></i> Traditional Chinese Medicine</h4>
                    <p>Balance Qi through foods that nourish blood and strengthen the immune system according to TCM principles.</p>
                    <div class="tradition-foods">
                        <strong>Recommended:</strong> Congee, bone broth, goji berries, green vegetables, moderate portions
                    </div>
                </div>
            `;
        }
        
        if (traditions.includes('mediterranean')) {
            holisticContent += `
                <div class="tradition-section">
                    <h4><i class="fas fa-olive-branch"></i> Mediterranean Wisdom</h4>
                    <p>Emphasize whole foods, healthy fats, and the social aspects of eating for overall well-being.</p>
                    <div class="tradition-foods">
                        <strong>Recommended:</strong> Olive oil, fish, vegetables, herbs, communal meals
                    </div>
                </div>
            `;
        }
        
        // Mind-Body Practice Recommendations
        if (mindBodyPractices.length > 0) {
            holisticContent += `
                <div class="tradition-section">
                    <h4><i class="fas fa-brain"></i> Mind-Body Nutrition</h4>
                    <p>Your selected practices complement nutritional healing:</p>
                    <ul class="mind-body-list">
            `;
            
            if (mindBodyPractices.includes('meditation')) {
                holisticContent += `<li><strong>Meditation:</strong> Practice mindful eating, chew slowly, appreciate food</li>`;
            }
            if (mindBodyPractices.includes('yoga')) {
                holisticContent += `<li><strong>Yoga:</strong> Gentle movement aids digestion, practice before/after meals</li>`;
            }
            if (mindBodyPractices.includes('breathwork')) {
                holisticContent += `<li><strong>Breathwork:</strong> Deep breathing before meals activates parasympathetic nervous system</li>`;
            }
            if (mindBodyPractices.includes('tai-chi')) {
                holisticContent += `<li><strong>Tai Chi:</strong> Gentle movement supports Qi flow and digestive health</li>`;
            }
            if (mindBodyPractices.includes('energy-healing')) {
                holisticContent += `<li><strong>Energy Healing:</strong> Balance energy centers, consider foods that support chakras</li>`;
            }
            
            holisticContent += `</ul></div>`;
        }
        
        // Constitutional Recommendations
        if (constitution) {
            holisticContent += `
                <div class="tradition-section">
                    <h4><i class="fas fa-user-circle"></i> Constitutional Guidance</h4>
            `;
            
            switch(constitution) {
                case 'vata':
                    holisticContent += `<p><strong>Vata Constitution:</strong> Favor warm, moist, grounding foods. Regular meal times, avoid cold/raw foods during treatment.</p>`;
                    break;
                case 'pitta':
                    holisticContent += `<p><strong>Pitta Constitution:</strong> Cooling, calming foods. Avoid spicy, acidic foods. Favor sweet, bitter, astringent tastes.</p>`;
                    break;
                case 'kapha':
                    holisticContent += `<p><strong>Kapha Constitution:</strong> Light, warming, spicy foods. Avoid heavy, oily foods. Favor pungent, bitter, astringent tastes.</p>`;
                    break;
                case 'yang-deficiency':
                    holisticContent += `<p><strong>Yang Deficiency:</strong> Warming foods, cooked vegetables, avoid cold/raw foods. Gentle warming spices.</p>`;
                    break;
                case 'yin-deficiency':
                    holisticContent += `<p><strong>Yin Deficiency:</strong> Nourishing, moistening foods. Avoid excessive spicy/heating foods. Focus on building fluids.</p>`;
                    break;
                case 'qi-stagnation':
                    holisticContent += `<p><strong>Qi Stagnation:</strong> Moving foods like citrus peel, light movement after meals. Avoid heavy, greasy foods.</p>`;
                    break;
            }
            
            holisticContent += `</div>`;
        }
        
        holisticContent += `
                </div>
                <div class="holistic-note">
                    <i class="fas fa-info-circle"></i>
                    <small>Holistic approaches complement conventional treatment. Always discuss with your healthcare team before making significant dietary changes.</small>
                </div>
            </div>
        `;
    }
    
    return holisticContent;
}

function getRecommendedRecipeCategories(userData) {
    let categories = [];
    
    // Based on symptoms
    if (userData.symptoms.includes('nausea') || userData.symptoms.includes('appetite-loss')) {
        categories.push({name: 'Symptom Management', filter: 'symptom-management', icon: 'fas fa-heart-pulse'});
    }
    
    if (userData.symptoms.includes('mouth-sores') || userData.symptoms.includes('digestive')) {
        categories.push({name: 'Texture Modified', filter: 'texture-modified', icon: 'fas fa-blender'});
    }
    
    // Based on treatment stage
    if (userData.treatmentStage === 'active-treatment' || userData.treatmentStage === 'post-treatment') {
        categories.push({name: 'High Protein/Calorie', filter: 'high-protein-high-calorie', icon: 'fas fa-dumbbell'});
        categories.push({name: 'Therapeutic/Medical', filter: 'therapeutic-medical', icon: 'fas fa-pills'});
    }
    
    // Always include general healthy
    categories.push({name: 'General Healthy', filter: 'general-healthy', icon: 'fas fa-leaf'});
    
    // Add holistic categories based on user preferences
    if (userData.nutritionApproach && userData.nutritionApproach !== 'conventional') {
        if (userData.traditionalMedicine) {
            if (userData.traditionalMedicine.includes('ayurveda')) {
                categories.push({name: 'Ayurvedic', filter: 'ayurvedic', icon: 'fas fa-leaf'});
            }
            if (userData.traditionalMedicine.includes('tcm')) {
                categories.push({name: 'Traditional Chinese Medicine', filter: 'tcm', icon: 'fas fa-mountain'});
            }
            if (userData.traditionalMedicine.includes('mediterranean')) {
                categories.push({name: 'Mediterranean', filter: 'mediterranean-holistic', icon: 'fas fa-olive-branch'});
            }
        }
        
        // Add functional medicine and mind-body categories for alternative/integrated approaches
        if (userData.nutritionApproach === 'alternative' || userData.nutritionApproach === 'integrated') {
            categories.push({name: 'Functional Medicine', filter: 'functional-medicine', icon: 'fas fa-microscope'});
            
            if (userData.mindBodyPractices && userData.mindBodyPractices.length > 0) {
                categories.push({name: 'Mind-Body Nutrition', filter: 'mind-body', icon: 'fas fa-brain'});
            }
        }
    }
    
    // Store the recommended filters globally for use by "Explore Recommended Recipes" button
    currentUserRecommendedFilters = categories.map(cat => cat.filter);
    
    return categories.map(cat => `
        <button class="recipe-category-btn" onclick="showSection('recipesSection'); setTimeout(() => filterRecipes('${cat.filter}'), 100);">
            <i class="${cat.icon}"></i>
            <span>${cat.name}</span>
        </button>
    `).join('');
}

function initializeTracking() {
    // Initialize current date
    const today = new Date();
    let currentTrackingDate = new Date(today);
    updateDateDisplay();
    
    // Load today's nutrition data
    loadNutritionData(formatDateForStorage(currentTrackingDate));
    
    // Add event listeners for date navigation
    const prevDayBtn = document.getElementById('prevDay');
    const nextDayBtn = document.getElementById('nextDay');
    
    if (prevDayBtn) {
        prevDayBtn.addEventListener('click', () => {
            currentTrackingDate.setDate(currentTrackingDate.getDate() - 1);
            updateDateDisplay();
            loadNutritionData(formatDateForStorage(currentTrackingDate));
        });
    }
    
    if (nextDayBtn) {
        nextDayBtn.addEventListener('click', () => {
            currentTrackingDate.setDate(currentTrackingDate.getDate() + 1);
            updateDateDisplay();
            loadNutritionData(formatDateForStorage(currentTrackingDate));
        });
    }
    
    function updateDateDisplay() {
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            dateElement.textContent = currentTrackingDate.toLocaleDateString('en-US', options);
        }
    }
    
    function formatDateForStorage(date) {
        return date.toISOString().split('T')[0]; // YYYY-MM-DD format
    }
}

function loadNutritionData(dateString) {
    // Get stored nutrition data for the date
    const nutritionData = JSON.parse(localStorage.getItem(`nutrition_${dateString}`) || '{"foods": [], "totals": {"calories": 0, "protein": 0, "fluids": 0}}');
    
    // Update nutrition summary displays
    updateNutritionSummary(nutritionData.totals);
    
    // Update food log
    updateFoodLog(nutritionData.foods);
}

function updateNutritionSummary(totals) {
    // Update calorie count
    const caloriesElement = document.getElementById('caloriesCount');
    if (caloriesElement) {
        caloriesElement.textContent = totals.calories || 0;
    }
    
    // Update protein count
    const proteinElement = document.getElementById('proteinCount');
    if (proteinElement) {
        proteinElement.textContent = totals.protein || 0;
    }
    
    // Update fluids count
    const fluidsElement = document.getElementById('fluidsCount');
    if (fluidsElement) {
        fluidsElement.textContent = totals.fluids || 0;
    }
}

function updateFoodLog(foods) {
    const foodLogContainer = document.getElementById('foodLogEntries');
    if (!foodLogContainer) return;
    
    if (foods.length === 0) {
        foodLogContainer.innerHTML = '<p class="empty-log">No foods or fluids logged today. Start by adding your first meal or drink!</p>';
        return;
    }
    
    // Group foods by meal type and fluids by time
    const mealGroups = {
        breakfast: [],
        lunch: [],
        dinner: [],
        snack: [],
        fluids: []  // All fluids go into a separate group
    };
    
    foods.forEach(item => {
        if (item.type === 'fluid') {
            mealGroups.fluids.push(item);
        } else if (mealGroups[item.meal]) {
            mealGroups[item.meal].push(item);
        }
    });
    
    let html = '';
    
    // Display meal groups first
    const mealOrder = ['breakfast', 'lunch', 'dinner', 'snack'];
    mealOrder.forEach(mealType => {
        const mealFoods = mealGroups[mealType];
        if (mealFoods.length > 0) {
            const mealName = mealType.charAt(0).toUpperCase() + mealType.slice(1);
            html += `
                <div class="meal-group">
                    <h4 class="meal-title"><i class="fas fa-utensils"></i> ${mealName}</h4>
                    <div class="meal-foods">
                        ${mealFoods.map(food => `
                            <div class="food-entry">
                                <div class="food-info">
                                    <span class="food-name">${food.name}</span>
                                    <span class="food-portion">${food.portion || food.amount}</span>
                                </div>
                                <div class="food-nutrition">
                                    <span class="calories">${food.calories || 0} cal</span>
                                    <span class="protein">${food.protein || 0}g protein</span>
                                </div>
                                <button class="remove-food-btn" onclick="removeFoodItem('${food.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    // Display fluids group
    if (mealGroups.fluids.length > 0) {
        html += `
            <div class="meal-group">
                <h4 class="meal-title"><i class="fas fa-tint"></i> Fluid Intake</h4>
                <div class="meal-foods">
                    ${mealGroups.fluids.map(fluid => `
                        <div class="food-entry fluid-entry">
                            <div class="food-info">
                                <span class="food-name">${fluid.name}</span>
                                <span class="food-portion">${fluid.amount} - ${fluid.time}</span>
                            </div>
                            <div class="food-nutrition">
                                <span class="calories">${fluid.calories || 0} cal</span>
                                <span class="fluids">${fluid.fluids || 0}ml</span>
                            </div>
                            <button class="remove-food-btn" onclick="removeFoodItem('${fluid.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    foodLogContainer.innerHTML = html;
}

function openFoodModal() {
    const modal = document.getElementById('foodModal');
    if (modal) {
        // Scroll to top before showing modal
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        
        // Show modal after a brief delay to ensure smooth scrolling
        setTimeout(() => {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Clear form fields
            document.getElementById('foodName').value = '';
            document.getElementById('portion').value = '';
            document.getElementById('mealType').selectedIndex = 0;
        }, 100);
    }
}

function closeFoodModal() {
    const modal = document.getElementById('foodModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

function addFoodItem() {
    const foodName = document.getElementById('foodName').value.trim();
    const portion = document.getElementById('portion').value.trim();
    const mealType = document.getElementById('mealType').value;
    
    // Validate required fields
    if (!foodName) {
        alert('Please enter a food name');
        document.getElementById('foodName').focus();
        return;
    }
    
    if (!portion) {
        alert('Please enter a portion size');
        document.getElementById('portion').focus();
        return;
    }
    
    if (!foodName || !portion) {
        alert('Please enter both food name and portion size');
        return;
    }
    
    // Create food item with estimated nutrition values
    const foodItem = {
        id: Date.now().toString(),
        name: foodName,
        portion: portion,
        meal: mealType,
        calories: estimateCalories(foodName, portion),
        protein: estimateProtein(foodName, portion),
        fluids: estimateFluids(foodName, portion),
        timestamp: new Date().toISOString()
    };
    
    // Get current date for storage
    const today = new Date();
    const dateString = today.toISOString().split('T')[0];
    
    // Get existing nutrition data
    const nutritionData = JSON.parse(localStorage.getItem(`nutrition_${dateString}`) || '{"foods": [], "totals": {"calories": 0, "protein": 0, "fluids": 0}}');
    
    // Add new food item
    nutritionData.foods.push(foodItem);
    
    // Update totals
    nutritionData.totals.calories += foodItem.calories;
    nutritionData.totals.protein += foodItem.protein;
    nutritionData.totals.fluids += foodItem.fluids;
    
    // Save updated data
    localStorage.setItem(`nutrition_${dateString}`, JSON.stringify(nutritionData));
    
    // Refresh displays
    updateNutritionSummary(nutritionData.totals);
    updateFoodLog(nutritionData.foods);
    
    // Close modal
    closeFoodModal();
}

// Fluid Tracking Functions
function openFluidModal() {
    const modal = document.getElementById('fluidModal');
    if (modal) {
        // Scroll to top before showing modal
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        
        // Show modal after a brief delay to ensure smooth scrolling
        setTimeout(() => {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Clear form fields
            document.getElementById('fluidType').selectedIndex = 0;
            document.getElementById('customFluid').value = '';
            document.getElementById('fluidAmount').value = '';
            document.getElementById('fluidTime').selectedIndex = 0;
            
            // Hide custom fluid input initially
            const customFluidGroup = document.querySelector('.custom-fluid-group');
            if (customFluidGroup) {
                customFluidGroup.style.display = 'none';
            }
        }, 100);
    }
}

function closeFluidModal() {
    const modal = document.getElementById('fluidModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

function addFluidItem() {
    const fluidType = document.getElementById('fluidType').value;
    const customFluid = document.getElementById('customFluid').value.trim();
    const fluidAmount = parseInt(document.getElementById('fluidAmount').value);
    const fluidTime = document.getElementById('fluidTime').value;
    
    // Validate required fields
    if (!fluidAmount || fluidAmount <= 0) {
        alert('Please enter a valid fluid amount');
        document.getElementById('fluidAmount').focus();
        return;
    }
    
    if (fluidAmount > 2000) {
        alert('Amount seems too large. Please enter a reasonable amount (max 2000ml)');
        document.getElementById('fluidAmount').focus();
        return;
    }
    
    // Determine fluid name
    let fluidName = fluidType;
    if (fluidType === 'other' && customFluid) {
        fluidName = customFluid;
    } else if (fluidType === 'other' && !customFluid) {
        alert('Please specify the fluid type');
        document.getElementById('customFluid').focus();
        return;
    }
    
    // Create fluid item
    const fluidItem = {
        id: Date.now().toString(),
        type: 'fluid',
        name: getFluidDisplayName(fluidName),
        amount: `${fluidAmount}ml`,
        time: fluidTime,
        calories: getFluidCalories(fluidName, fluidAmount),
        protein: 0, // Most fluids don't contain significant protein
        fluids: fluidAmount,
        timestamp: new Date().toISOString()
    };
    
    // Get current date for storage
    const today = new Date();
    const dateString = today.toISOString().split('T')[0];
    
    // Get existing nutrition data
    const nutritionData = JSON.parse(localStorage.getItem(`nutrition_${dateString}`) || '{"foods": [], "totals": {"calories": 0, "protein": 0, "fluids": 0}}');
    
    // Add new fluid item
    nutritionData.foods.push(fluidItem);
    
    // Update totals
    nutritionData.totals.calories += fluidItem.calories;
    nutritionData.totals.protein += fluidItem.protein;
    nutritionData.totals.fluids += fluidItem.fluids;
    
    // Save updated data
    localStorage.setItem(`nutrition_${dateString}`, JSON.stringify(nutritionData));
    
    // Refresh displays
    updateNutritionSummary(nutritionData.totals);
    updateFoodLog(nutritionData.foods);
    
    // Close modal
    closeFluidModal();
}

function getFluidDisplayName(fluidType) {
    const displayNames = {
        'water': 'Water',
        'herbal-tea': 'Herbal Tea',
        'green-tea': 'Green Tea',
        'broth': 'Broth/Soup',
        'juice': 'Fruit/Vegetable Juice',
        'milk': 'Milk',
        'smoothie': 'Smoothie'
    };
    return displayNames[fluidType] || fluidType;
}

function getFluidCalories(fluidType, amount) {
    // Rough calorie estimates per 100ml
    const caloriesPerMl = {
        'water': 0,
        'herbal-tea': 0,
        'green-tea': 0,
        'broth': 0.1,
        'juice': 0.4,
        'milk': 0.42,
        'smoothie': 0.6
    };
    
    const calorieRate = caloriesPerMl[fluidType] || 0;
    return Math.round(calorieRate * amount);
}

function removeFoodItem(foodId) {
    const today = new Date();
    const dateString = today.toISOString().split('T')[0];
    
    // Get existing nutrition data
    const nutritionData = JSON.parse(localStorage.getItem(`nutrition_${dateString}`) || '{"foods": [], "totals": {"calories": 0, "protein": 0, "fluids": 0}}');
    
    // Find and remove food item (ensure ID comparison works with both string and number IDs)
    const foodIndex = nutritionData.foods.findIndex(food => food.id.toString() === foodId.toString());
    if (foodIndex === -1) {
        console.warn('Food item not found:', foodId);
        return;
    }
    
    const removedFood = nutritionData.foods[foodIndex];
    nutritionData.foods.splice(foodIndex, 1);
    
    // Update totals
    nutritionData.totals.calories -= removedFood.calories;
    nutritionData.totals.protein -= removedFood.protein;
    nutritionData.totals.fluids -= removedFood.fluids;
    
    // Ensure totals don't go below 0
    nutritionData.totals.calories = Math.max(0, nutritionData.totals.calories);
    nutritionData.totals.protein = Math.max(0, nutritionData.totals.protein);
    nutritionData.totals.fluids = Math.max(0, nutritionData.totals.fluids);
    
    // Save updated data
    localStorage.setItem(`nutrition_${dateString}`, JSON.stringify(nutritionData));
    
    // Refresh displays
    updateNutritionSummary(nutritionData.totals);
    updateFoodLog(nutritionData.foods);
}

// Simple nutrition estimation functions (could be enhanced with a real nutrition database)
function estimateCalories(foodName, portion) {
    const food = foodName.toLowerCase();
    let baseCalories = 100; // default estimate
    
    // Simple estimation based on food type
    if (food.includes('rice') || food.includes('pasta') || food.includes('bread')) {
        baseCalories = 200;
    } else if (food.includes('chicken') || food.includes('beef') || food.includes('fish')) {
        baseCalories = 250;
    } else if (food.includes('vegetable') || food.includes('salad')) {
        baseCalories = 50;
    } else if (food.includes('fruit') || food.includes('apple') || food.includes('banana')) {
        baseCalories = 80;
    } else if (food.includes('nuts') || food.includes('oil') || food.includes('butter')) {
        baseCalories = 400;
    }
    
    // Adjust for portion (very basic)
    const portionLower = portion.toLowerCase();
    let multiplier = 1;
    if (portionLower.includes('large') || portionLower.includes('2 cup')) {
        multiplier = 1.5;
    } else if (portionLower.includes('small') || portionLower.includes('1/2 cup')) {
        multiplier = 0.5;
    }
    
    return Math.round(baseCalories * multiplier);
}

function estimateProtein(foodName, portion) {
    const food = foodName.toLowerCase();
    let baseProtein = 3; // default estimate
    
    if (food.includes('chicken') || food.includes('beef') || food.includes('fish')) {
        baseProtein = 25;
    } else if (food.includes('egg')) {
        baseProtein = 12;
    } else if (food.includes('beans') || food.includes('lentil')) {
        baseProtein = 15;
    } else if (food.includes('nuts')) {
        baseProtein = 8;
    } else if (food.includes('rice') || food.includes('pasta')) {
        baseProtein = 5;
    } else if (food.includes('vegetable') || food.includes('fruit')) {
        baseProtein = 1;
    }
    
    const portionLower = portion.toLowerCase();
    let multiplier = 1;
    if (portionLower.includes('large') || portionLower.includes('2 cup')) {
        multiplier = 1.5;
    } else if (portionLower.includes('small') || portionLower.includes('1/2 cup')) {
        multiplier = 0.5;
    }
    
    return Math.round(baseProtein * multiplier);
}

function estimateFluids(foodName, portion) {
    const food = foodName.toLowerCase();
    let baseFluid = 0; // default estimate for solid foods
    
    if (food.includes('water') || food.includes('juice') || food.includes('tea') || food.includes('coffee')) {
        baseFluid = 250; // assuming 1 cup
    } else if (food.includes('soup') || food.includes('broth')) {
        baseFluid = 200;
    } else if (food.includes('smoothie') || food.includes('milk')) {
        baseFluid = 250;
    } else if (food.includes('fruit') || food.includes('vegetable')) {
        baseFluid = 50; // water content in fruits/vegetables
    }
    
    const portionLower = portion.toLowerCase();
    let multiplier = 1;
    if (portionLower.includes('large') || portionLower.includes('2 cup')) {
        multiplier = 1.5;
    } else if (portionLower.includes('small') || portionLower.includes('1/2 cup')) {
        multiplier = 0.5;
    }
    
    return Math.round(baseFluid * multiplier);
}

function initializeLearnSection() {
    // Add event listeners for learning tabs
    const learningTabs = document.querySelectorAll('.learning-tab');
    const learningPanels = document.querySelectorAll('.learning-panel');
    
    learningTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and panels
            learningTabs.forEach(t => t.classList.remove('active'));
            learningPanels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding panel
            this.classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
        });
    });
}

function loadResources() {
    // Resources are already loaded in HTML, just ensure they're interactive
    console.log('Resources section loaded with', Object.keys(educationalResources).length, 'resources');
}

function openResource(resourceId) {
    const resource = educationalResources[resourceId];
    if (!resource) {
        console.error('Resource not found:', resourceId);
        return;
    }
    
    // Create and show resource modal
    showResourceModal(resource);
}

function showResourceModal(resource) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('resourceModal');
    if (!modal) {
        modal = createResourceModal();
    }
    
    // Populate modal content
    const modalTitle = modal.querySelector('.resource-modal-title');
    const modalOrganization = modal.querySelector('.resource-modal-organization');
    const modalDescription = modal.querySelector('.resource-modal-description');
    const modalJournalInfo = modal.querySelector('.resource-modal-journal');
    const modalLink = modal.querySelector('.resource-modal-link');
    
    modalTitle.textContent = resource.title;
    modalOrganization.innerHTML = `<i class="${resource.icon}"></i> ${resource.organization}`;
    modalDescription.textContent = resource.description;
    modalJournalInfo.textContent = resource.journalInfo;
    modalLink.href = resource.url;
    modalLink.onclick = () => {
        window.open(resource.url, '_blank', 'noopener,noreferrer');
        closeResourceModal();
        return false;
    };
    
    // Scroll to top before showing modal
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
    
    // Show modal after a brief delay to ensure smooth scrolling
    setTimeout(() => {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }, 100);
}

function createResourceModal() {
    const modal = document.createElement('div');
    modal.id = 'resourceModal';
    modal.className = 'modal hidden';
    
    modal.innerHTML = `
        <div class="modal-content resource-modal-content">
            <div class="modal-header">
                <div class="resource-modal-organization"></div>
                <button class="close-modal" onclick="closeResourceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h3 class="resource-modal-title"></h3>
                <p class="resource-modal-description"></p>
                <div class="resource-modal-meta">
                    <div class="journal-info">
                        <i class="fas fa-info-circle"></i>
                        <span class="resource-modal-journal"></span>
                    </div>
                </div>
                <div class="resource-modal-actions">
                    <a href="#" class="btn btn-primary resource-modal-link" target="_blank">
                        <i class="fas fa-external-link-alt"></i> View Resource
                    </a>
                    <button class="btn btn-secondary" onclick="closeResourceModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    return modal;
}

function closeResourceModal() {
    const modal = document.getElementById('resourceModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

// Accessibility Functions
function initializeAccessibilityToggle() {
    const toggleBtn = document.getElementById('toggleHighContrast');
    if (!toggleBtn) return;
    
    // Check if high contrast was previously enabled
    const isHighContrastEnabled = localStorage.getItem('highContrastMode') === 'true';
    if (isHighContrastEnabled) {
        document.body.classList.add('high-contrast');
        updateToggleButtonState(toggleBtn, true);
    }
    
    // Add click event listener
    toggleBtn.addEventListener('click', function() {
        const isCurrentlyEnabled = document.body.classList.contains('high-contrast');
        
        if (isCurrentlyEnabled) {
            // Disable high contrast
            document.body.classList.remove('high-contrast');
            localStorage.setItem('highContrastMode', 'false');
            updateToggleButtonState(toggleBtn, false);
        } else {
            // Enable high contrast
            document.body.classList.add('high-contrast');
            localStorage.setItem('highContrastMode', 'true');
            updateToggleButtonState(toggleBtn, true);
        }
    });
}

function updateToggleButtonState(button, isHighContrast) {
    const icon = button.querySelector('i');
    if (isHighContrast) {
        icon.className = 'fas fa-eye-slash';
        button.setAttribute('aria-label', 'Disable high contrast mode');
        button.title = 'Disable high contrast mode';
    } else {
        icon.className = 'fas fa-eye';
        button.setAttribute('aria-label', 'Enable high contrast mode');
        button.title = 'Enable high contrast mode';
    }
}

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    // Show welcome section by default
    showSection('welcomeSection');
    
    // Initialize high contrast toggle
    initializeAccessibilityToggle();
    
    // Add form submission handler
    const assessmentForm = document.getElementById('assessmentForm');
    if (assessmentForm) {
        assessmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get symptoms
            const symptoms = [];
            document.querySelectorAll('input[name="symptoms"]:checked').forEach(checkbox => {
                symptoms.push(checkbox.value);
            });
            
            // Get holistic preferences
            const traditionMedicine = [];
            document.querySelectorAll('input[name="traditional_medicine"]:checked').forEach(checkbox => {
                traditionMedicine.push(checkbox.value);
            });
            
            const mindBodyPractices = [];
            document.querySelectorAll('input[name="mind_body_practices"]:checked').forEach(checkbox => {
                mindBodyPractices.push(checkbox.value);
            });
            
            const profileData = {
                cancerType: document.getElementById('cancerType').value,
                treatmentStage: document.getElementById('treatmentStage').value,
                location: document.getElementById('location').value,
                specificLocation: document.getElementById('specificLocation').value,
                symptoms: symptoms,
                allergies: document.getElementById('allergies').value,
                nutritionApproach: document.getElementById('nutritionApproach').value,
                traditionalMedicine: traditionMedicine,
                mindBodyPractices: mindBodyPractices,
                constitutionalType: document.getElementById('constitution').value,
                timestamp: new Date().toISOString()
            };
            
            // Update global holistic preferences
            userHolisticPreferences = {
                approach: profileData.nutritionApproach,
                traditions: profileData.traditionalMedicine,
                mindBody: profileData.mindBodyPractices,
                constitution: profileData.constitutionalType
            };
            
            // Validate required fields
            if (!profileData.cancerType || !profileData.treatmentStage || !profileData.location) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }
            
            // Save profile data
            saveUserProfile(profileData);
            
            // Show success message and redirect to recommendations
            const submitBtn = assessmentForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-check"></i> Saved! Loading recommendations...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                showSection('recommendationsSection');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 1000);
        });
    }
    
    // Add event listeners for filter buttons
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Filter recipes
            const category = this.getAttribute('data-filter');
            filterRecipes(category);
        });
    });
    
    // Add event listener for fluid type selection
    const fluidTypeSelect = document.getElementById('fluidType');
    if (fluidTypeSelect) {
        fluidTypeSelect.addEventListener('change', function() {
            const customFluidGroup = document.getElementById('customFluidGroup');
            if (this.value === 'other') {
                customFluidGroup.style.display = 'block';
                document.getElementById('customFluid').focus();
            } else {
                customFluidGroup.style.display = 'none';
            }
        });
    }
    
    // Close modal on backdrop click
    document.addEventListener('click', (e) => {
        const recipeModal = document.getElementById('recipeModal');
        const resourceModal = document.getElementById('resourceModal');
        const foodModal = document.getElementById('foodModal');
        const fluidModal = document.getElementById('fluidModal');
        
        if (e.target === recipeModal) {
            closeRecipeModal();
        } else if (e.target === resourceModal) {
            closeResourceModal();
        } else if (e.target === foodModal) {
            closeFoodModal();
        } else if (e.target === fluidModal) {
            closeFluidModal();
        }
    });
    
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeRecipeModal();
            closeResourceModal();
            closeFoodModal();
            closeFluidModal();
        }
    });
});

// Clear Profile Form Function
function clearProfileForm() {
    if (confirm('Are you sure you want to clear all form data? This action cannot be undone.')) {
        // Clear all form fields
        document.getElementById('cancerType').value = '';
        document.getElementById('treatmentStage').value = '';
        document.getElementById('location').value = '';
        document.getElementById('specificLocation').value = '';
        document.getElementById('allergies').value = '';
        document.getElementById('nutritionApproach').value = 'conventional';
        document.getElementById('constitution').value = '';
        
        // Clear all checkboxes
        const symptomCheckboxes = document.querySelectorAll('input[name="symptoms"]');
        symptomCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        const traditionalMedicineCheckboxes = document.querySelectorAll('input[name="traditional_medicine"]');
        traditionalMedicineCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        const mindBodyCheckboxes = document.querySelectorAll('input[name="mind_body_practices"]');
        mindBodyCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Clear global holistic preferences
        userHolisticPreferences = {
            approach: 'conventional',
            traditions: [],
            mindBody: [],
            constitution: ''
        };
        
        // Clear any saved profile data from localStorage
        localStorage.removeItem('userProfile');
        localStorage.removeItem('userProfile');
        
        // Show success message
        alert('Profile form cleared successfully!');
    }
}

// Clear Today's Tracking Data Function
function clearTodayTracking() {
    if (confirm('Are you sure you want to clear all food and fluid entries for today? This action cannot be undone.')) {
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        
        // Clear today's nutrition data from localStorage
        localStorage.removeItem(`nutrition_${dateString}`);
        
        // Reset the UI
        document.getElementById('caloriesCount').textContent = '0';
        document.getElementById('proteinCount').textContent = '0';
        document.getElementById('fluidsCount').textContent = '0';
        
        // Clear the food log display
        const foodLogEntries = document.getElementById('foodLogEntries');
        if (foodLogEntries) {
            foodLogEntries.innerHTML = '<p class="empty-log">No foods logged today. Start by adding your first meal!</p>';
        }
        
        // Show success message
        alert('Today\'s tracking data cleared successfully!');
    }
}
